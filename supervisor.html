<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); min-height: 100vh; }

        /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
        #loginScreen { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-container { background: #fff; border-radius: 20px; padding: 50px 40px; box-shadow: 0 20px 60px rgba(0,0,0,.3); max-width: 450px; width: 100%; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-icon { font-size: 4em; margin-bottom: 15px; }
        .login-header h1 { color: #333; margin-bottom: 10px; font-size: 2em; }
        .login-header p { color: #666; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: border-color .3s; }
        .form-group input:focus { outline: none; border-color: #43e97b; }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg,#43e97b,#38f9d7); color: #fff; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: transform .3s, box-shadow .3s; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(67,233,123,.4); }
        .error-message { background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; border: 1px solid #fcc; }
        .back-link { text-align: center; margin-top: 20px; }
        .back-link a { color: #666; text-decoration: none; }
        .back-link a:hover { color: #43e97b; }

        /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
        #dashboard { display: none; background: #f5f7fa; min-height: 100vh; }
        #dashboard.active { display: block; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .dashboard-header { background: #fff; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,.1); display: flex; justify-content: space-between; align-items: center; }
        .user-info h2 { color: #333; margin-bottom: 5px; }
        .user-info p { color: #666; }
        .logout-btn { background: rgba(67,233,123,.2); color: #2d8a56; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; }
        .logout-btn:hover { background: rgba(67,233,123,.3); }

        /* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: #fff; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
        .summary-card .icon { font-size: 2em; margin-bottom: 10px; }
        .summary-card .value { font-size: 2em; font-weight: 700; color: #333; }
        .summary-card .label { color: #666; font-size: .9em; margin-top: 5px; }

        /* ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ */
        .tab-nav { display: flex; gap: 0; margin-bottom: 30px; background: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
        .tab-btn { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-size: 1.1em; font-weight: 600; color: #666; border: none; background: #fff; transition: all .3s; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: #f9f9f9; color: #333; }
        .tab-btn.active { color: #2d8a56; border-bottom-color: #43e97b; background: linear-gradient(180deg,#f0fdf4,#fff); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
        .section-card { background: #fff; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
        .section-card h3 { color: #333; margin-bottom: 25px; font-size: 1.4em; display: flex; align-items: center; gap: 10px; }

        /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead { background: linear-gradient(135deg,#f0fdf4,#e8f5e9); }
        .data-table th { padding: 14px 12px; text-align: left; color: #333; font-weight: 600; font-size: .9em; white-space: nowrap; }
        .data-table td { padding: 14px 12px; border-bottom: 1px solid #f0f0f0; color: #555; font-size: .9em; }
        .data-table tbody tr:hover { background: #f9f9f9; }
        .total-row { background: linear-gradient(135deg,#f0fdf4,#e8f5e9); font-weight: 700; }
        .total-row td { padding: 18px 12px; border-bottom: none; }
        .no-data { text-align: center; padding: 40px; color: #999; font-style: italic; }
        .sales-val { color: #2d8a56; font-weight: 600; }
        .pct-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: .85em; }
        .pct-high { background: #d4edda; color: #155724; }
        .pct-mid { background: #fff3cd; color: #856404; }
        .pct-low { background: #f8d7da; color: #721c24; }

        /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
        .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px; }
        .toolbar input[type="text"] { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: .95em; min-width: 200px; }
        .toolbar input:focus,.toolbar select:focus { outline: none; border-color: #43e97b; }
        .toolbar select { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: .9em; background: #fff; cursor: pointer; }
        .toolbar label { font-size: .85em; color: #666; font-weight: 600; }
        .toolbar-group { display: flex; align-items: center; gap: 6px; }

        .group-header-row td { background: linear-gradient(135deg,#e8f5e9,#f1f8e9); font-weight: 700; color: #333; padding: 12px; border-bottom: 2px solid #43e97b; }
        .group-subtotal-row td { background: #fafafa; font-weight: 600; color: #555; font-style: italic; border-bottom: 2px solid #e0e0e0; }

        .rating-stars{color:#43e97b;font-weight:700}
        .photo-link{color:#2d8a56;font-size:.8em;margin-right:6px;text-decoration:none}
        .photo-link:hover{text-decoration:underline}
        .photo-count-badge{background:#e8f5e9;color:#2d8a56;padding:3px 10px;border-radius:10px;font-size:.8em;font-weight:600}
        .survey-count-card{background:#fff;border-radius:15px;padding:25px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .survey-loading{text-align:center;padding:30px;color:#999}

        /* ‚îÄ‚îÄ Progress bar in table ‚îÄ‚îÄ */
        .mini-progress { width: 80px; height: 8px; background: #e0e0e0; border-radius: 4px; display: inline-block; vertical-align: middle; margin-left: 8px; }
        .mini-progress-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg,#43e97b,#38f9d7); }

        @media(max-width:768px){ .dashboard-header{flex-direction:column;gap:20px;text-align:center} .summary-grid{grid-template-columns:1fr 1fr} .toolbar{flex-direction:column;align-items:stretch} .toolbar input[type="text"]{min-width:auto;width:100%} .tab-btn{font-size:.9em;padding:15px 10px} }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-container">
        <div class="login-header"><div class="login-icon">üë®‚Äçüíº</div><h1>Supervisor Login</h1><p>Enter your credentials to continue</p></div>
        <div id="errorMessage" class="error-message"></div>
        <form id="loginForm">
            <div class="form-group"><label for="userName">User Name</label><input type="text" id="userName" placeholder="e.g. SUP" required></div>
            <div class="form-group"><label for="userCode">User ID</label><input type="text" id="userCode" placeholder="e.g. 123456" required></div>
            <button type="submit" class="login-btn">Log In</button>
        </form>
        <div class="back-link"><a href="index.html">‚Üê Back to Role Selection</a></div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="user-info"><h2>Welcome, <span id="dashName"></span>!</h2><p>Supervisor ID: <span id="dashCode"></span></p></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Summary -->
        <div class="summary-grid">
            <div class="summary-card"><div class="icon">üë•</div><div class="value" id="sumSalesmen">0</div><div class="label">Total Salesmen</div></div>
            <div class="summary-card"><div class="icon">üéØ</div><div class="value" id="sumTarget">0</div><div class="label">Total Target (SAR)</div></div>
            <div class="summary-card"><div class="icon">üí∞</div><div class="value" id="sumActual">0</div><div class="label">Total Actual (SAR)</div></div>
            <div class="summary-card"><div class="icon">üìä</div><div class="value" id="sumPct">0%</div><div class="label">Overall Achievement</div></div>
            <div class="summary-card"><div class="icon">üè™</div><div class="value" id="sumCustomers">0</div><div class="label">Total Customers</div></div>
            <div class="summary-card"><div class="icon">üìã</div><div class="value" id="sumSurveys">0</div><div class="label">Total Surveys</div></div>
        </div>

        <!-- Tabs -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('salesmen')">üë• My Salesmen</button>
            <button class="tab-btn" onclick="switchTab('customers')">üè™ All Customers</button>
            <button class="tab-btn" onclick="switchTab('surveys')">üìã Surveys</button>
        </div>

        <!-- TAB 1: My Salesmen -->
        <div id="tab-salesmen" class="tab-content active">
            <div class="section-card">
                <h3>üë• My Salesmen ‚Äî Performance Overview</h3>
                <table class="data-table">
                    <thead><tr><th>Code</th><th>Salesman</th><th>Route</th><th>Target</th><th>Actual</th><th>%TGT</th><th>Remaining</th><th>Progress</th></tr></thead>
                    <tbody id="salesmenTableBody"><tr><td colspan="8" class="no-data">Loading‚Ä¶</td></tr></tbody>
                    <tfoot><tr class="total-row"><td colspan="3">Total</td><td class="sales-val" id="smTotalTgt">0</td><td class="sales-val" id="smTotalAct">0</td><td class="sales-val" id="smTotalPct">0%</td><td class="sales-val" id="smTotalRem">0</td><td></td></tr></tfoot>
                </table>
            </div>
        </div>

        <!-- TAB 2: All Customers -->
        <div id="tab-customers" class="tab-content">
            <div class="section-card">
                <h3>üè™ All Customer Sales</h3>
                <div class="toolbar">
                    <input type="text" id="custSearch" placeholder="üîç Search...">
                    <div class="toolbar-group"><label>Salesman:</label><select id="filtSalesman"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Brand:</label><select id="filtBrand"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Customer:</label><select id="filtCustomer"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Product:</label><select id="filtProduct"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Date:</label><select id="filtDate"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Group By:</label><select id="custGroupBy"><option value="">None</option><option value="salesman">Salesman</option><option value="brand">Brand</option><option value="customer">Customer</option><option value="product">Product</option><option value="dayDate">Date</option></select></div>
                    <div class="toolbar-group"><label>Sort:</label><select id="custSortBy"><option value="">Default</option><option value="customer-asc">Customer ‚Üë</option><option value="customer-desc">Customer ‚Üì</option><option value="brand-asc">Brand ‚Üë</option><option value="brand-desc">Brand ‚Üì</option><option value="actualCY-asc">ACT-CY ‚Üë</option><option value="actualCY-desc">ACT-CY ‚Üì</option><option value="dayDate-asc">Date ‚Üë</option><option value="dayDate-desc">Date ‚Üì</option></select></div>
                </div>
                <table class="data-table">
                    <thead><tr><th>Salesman</th><th>Route</th><th>Code</th><th>Customer</th><th>Brand</th><th>Product</th><th>Date</th><th>ACT-CY</th><th>ACT-LY</th></tr></thead>
                    <tbody id="custTableBody"><tr><td colspan="9" class="no-data">Loading‚Ä¶</td></tr></tbody>
                    <tfoot><tr class="total-row"><td colspan="7">Total</td><td class="sales-val"><span id="custTotalCY">0</span></td><td class="sales-val"><span id="custTotalLY">0</span></td></tr></tfoot>
                </table>
            </div>
        </div>

        <!-- TAB 3: Surveys -->
        <div id="tab-surveys" class="tab-content">
            <div class="section-card">
                <h3>üìã Salesman Surveys</h3>
                <div class="toolbar">
                    <input type="text" id="surveySearch" placeholder="üîç Search surveys...">
                    <div class="toolbar-group"><label>Salesman:</label><select id="survFiltSM"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Customer:</label><select id="survFiltCust"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Rating:</label><select id="survFiltRating"><option value="">All</option><option value="low">1-4 (Low)</option><option value="mid">5-7 (Medium)</option><option value="high">8-10 (High)</option></select></div>
                    <div class="toolbar-group"><label>Sort:</label><select id="survSortBy"><option value="">Latest First</option><option value="rating-desc">Rating ‚Üì</option><option value="rating-asc">Rating ‚Üë</option><option value="salesman-asc">Salesman ‚Üë</option><option value="customer-asc">Customer ‚Üë</option></select></div>
                </div>
                <div id="surveyTableContainer"><p class="survey-loading">Loading surveys...</p></div>
            </div>
        </div>

    </div>
</div>

<script>
// ‚ïê‚ïê GOOGLE SHEETS CONFIG (data reading) ‚ïê‚ïê
const GOOGLE_SHEET_ID = '1fsAMrws9Of-XM69Q0IZY62SU8fYN2IL1g9vw58WquQI';
const SHEET_TABS = { users:'Users', salesmanSales:'SalesmanSales', masterData:'MasterData' };
// ‚ïê‚ïê POWER AUTOMATE CONFIG (surveys only) ‚ïê‚ïê
const POWER_AUTOMATE_GET_URL = 'https://default04af0493a5b44947ab72ae37fae884.14.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a52eaf1a49894199856439aa7e837f82/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=TKq2xFQ8rgo4juZL9h8SoNrPOH-gEe24DIOd7Jsu0Qw';

let usersData=[],salesmanSalesData=[],masterData=[],currentUser=null,mySalesmen=[],myMasterData=[];
let allSurveys=[];

function sanitize(s){const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}

async function fetchSheet(sheetId,tabName){if(!sheetId)return[];const url='https://docs.google.com/spreadsheets/d/'+sheetId+'/gviz/tq?tqx=out:json&sheet='+encodeURIComponent(tabName);try{const r=await fetch(url);if(!r.ok)return[];let t=await r.text();const s=t.indexOf('{'),e=t.lastIndexOf('}');if(s===-1||e===-1)return[];const j=JSON.parse(t.substring(s,e+1));if(!j.table||!j.table.cols||!j.table.rows)return[];const h=j.table.cols.map(c=>c.label||c.id||'');return j.table.rows.map(row=>{const o={};row.c.forEach((cell,i)=>{if(i<h.length&&h[i])o[h[i]]=cell?((cell.f!==undefined&&cell.f!==null)?cell.f:(cell.v!==undefined&&cell.v!==null?cell.v:'')):''});return o});}catch(e){console.error('Sheet error:',tabName,e);return[];}}
function toNum(v){const n=Number(v);return isNaN(n)?0:n;}

async function loadData(){
    if(GOOGLE_SHEET_ID){
        try{
            const[uR,sR,mR]=await Promise.all([fetchSheet(GOOGLE_SHEET_ID,SHEET_TABS.users),fetchSheet(GOOGLE_SHEET_ID,SHEET_TABS.salesmanSales),fetchSheet(GOOGLE_SHEET_ID,SHEET_TABS.masterData)]);
            if(uR.length){usersData=uR.map(r=>({userID:toNum(r.UserID),userName:r.UserName||'',role:r.Role||''}));}
            if(sR.length){salesmanSalesData=sR.map(r=>({salesmanCode:toNum(r.SalesmanCode),salesman:r.Salesman||'',routeCode:toNum(r.RouteCode),assignedSPV:toNum(r.AssignedSPV),target:toNum(r.Target),actualSales:toNum(r.ActualSales),targetPercent:toNum(r.TargetPercent)}));}
            if(mR.length){masterData=mR.map(r=>({salesmanCode:toNum(r.SalesmanCode),routeCode:toNum(r.RouteCode),assignedSPV:toNum(r.AssignedSPV),customerCode:r.CustomerCode||'',customer:r.Customer||'',brand:r.Brand||'',productGroup:r.ProductGroup||'',subBrand:r.SubBrand||'',product:r.Product||'',dayDate:r.DayDate||'',actualCY:toNum(r.ActualCY),actualLY:toNum(r.ActualLY)}));}
            console.log('GSheets loaded:',usersData.length,'users,',salesmanSalesData.length,'sales,',masterData.length,'master');
            if(usersData.length)return;
        }catch(e){console.error('GSheets error:',e);}
    }
    try{const[u,s,m]=await Promise.all([fetch('users_data.json'),fetch('salesman_sales.json'),fetch('master_data.json')]);
    usersData=await u.json();salesmanSalesData=await s.json();masterData=await m.json();}catch(e){console.error(e);
    usersData=[{"userID":75241,"userName":"Aseel","role":"Salesman"},{"userID":75242,"userName":"Ali","role":"Salesman"},{"userID":75243,"userName":"Ahmed","role":"Salesman"},{"userID":75244,"userName":"Amer","role":"Salesman"},{"userID":75245,"userName":"Amjad","role":"Salesman"},{"userID":12345,"userName":"Admin","role":"Management"},{"userID":123456,"userName":"SUP","role":"Supervisor"},{"userID":3001,"userName":"BSM","role":"BSM"}];
    salesmanSalesData=[{"salesmanCode":75241,"salesman":"Aseel","routeCode":1,"assignedSPV":123456,"target":3000,"actualSales":2700,"targetPercent":90},{"salesmanCode":75242,"salesman":"Ali","routeCode":2,"assignedSPV":123456,"target":3200,"actualSales":3000,"targetPercent":93.75},{"salesmanCode":75243,"salesman":"Ahmed","routeCode":3,"assignedSPV":123456,"target":3100,"actualSales":2800,"targetPercent":90.32},{"salesmanCode":75244,"salesman":"Amer","routeCode":4,"assignedSPV":123456,"target":3500,"actualSales":2700,"targetPercent":77.14},{"salesmanCode":75245,"salesman":"Amjad","routeCode":5,"assignedSPV":123456,"target":3300,"actualSales":2900,"targetPercent":87.88}];
    masterData=[{"salesmanCode":75241,"routeCode":1,"assignedSPV":123456,"customerCode":"C01","customer":"Aswaq 1","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","dayDate":"2026-02-07","actualCY":2000,"actualLY":6000},{"salesmanCode":75241,"routeCode":1,"assignedSPV":123456,"customerCode":"C01","customer":"Aswaq 1","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","dayDate":"2026-02-07","actualCY":700,"actualLY":3000},{"salesmanCode":75242,"routeCode":2,"assignedSPV":123456,"customerCode":"C03","customer":"Aswaq 3","brand":"BARBICAN","productGroup":"BBN CAN","subBrand":"BBN CAN APPLE","product":"BARBICAN CAN APPLE 330x6","dayDate":"2026-02-08","actualCY":1500,"actualLY":2000},{"salesmanCode":75242,"routeCode":2,"assignedSPV":123456,"customerCode":"C03","customer":"Aswaq 3","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","dayDate":"2026-02-08","actualCY":1500,"actualLY":1000},{"salesmanCode":75243,"routeCode":3,"assignedSPV":123456,"customerCode":"C04","customer":"Aswaq 4","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","dayDate":"2026-02-08","actualCY":2000,"actualLY":1000},{"salesmanCode":75243,"routeCode":3,"assignedSPV":123456,"customerCode":"C04","customer":"Aswaq 4","brand":"BARBICAN","productGroup":"BBN CAN","subBrand":"BBN CAN APPLE","product":"BARBICAN CAN APPLE 330x6","dayDate":"2026-02-09","actualCY":800,"actualLY":1000},{"salesmanCode":75244,"routeCode":4,"assignedSPV":123456,"customerCode":"C05","customer":"Aswaq 5","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","dayDate":"2026-02-09","actualCY":2700,"actualLY":2200},{"salesmanCode":75245,"routeCode":5,"assignedSPV":123456,"customerCode":"C06","customer":"Aswaq 6","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","dayDate":"2026-02-10","actualCY":2900,"actualLY":2500}];
    }
}

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
function switchTab(tab){
    const tabs=['salesmen','customers','surveys'];
    document.querySelectorAll('.tab-btn').forEach((b,i)=>{b.classList.toggle('active',i===tabs.indexOf(tab));});
    tabs.forEach(t=>{document.getElementById('tab-'+t).classList.toggle('active',t===tab);});
}

/* ‚ïê‚ïê TAB 1: SALESMEN TABLE ‚ïê‚ïê */
function renderSalesmenTable(){
    const tbody=document.getElementById('salesmenTableBody');
    if(!mySalesmen.length){tbody.innerHTML='<tr><td colspan="8" class="no-data">No salesmen assigned</td></tr>';return;}
    let html='',tTgt=0,tAct=0;
    mySalesmen.forEach(s=>{
        const rem=s.target-s.actualSales;const pct=s.targetPercent;
        const cls=pct>=100?'pct-high':pct>=85?'pct-mid':'pct-low';
        tTgt+=s.target;tAct+=s.actualSales;
        html+=`<tr>
            <td>${sanitize(s.salesmanCode)}</td><td style="font-weight:600;color:#333">${sanitize(s.salesman)}</td><td>${sanitize(s.routeCode)}</td>
            <td>${s.target.toLocaleString()}</td><td class="sales-val">${s.actualSales.toLocaleString()}</td>
            <td><span class="pct-badge ${cls}">${pct.toFixed(1)}%</span></td>
            <td>${rem>0?rem.toLocaleString():'‚Äî'}</td>
            <td><div class="mini-progress"><div class="mini-progress-fill" style="width:${Math.min(pct,100)}%"></div></div></td>
        </tr>`;
    });
    tbody.innerHTML=html;
    const oPct=tTgt?((tAct/tTgt)*100):0;
    document.getElementById('smTotalTgt').textContent=tTgt.toLocaleString();
    document.getElementById('smTotalAct').textContent=tAct.toLocaleString();
    document.getElementById('smTotalPct').textContent=oPct.toFixed(1)+'%';
    document.getElementById('smTotalRem').textContent=(tTgt-tAct>0?(tTgt-tAct).toLocaleString():'‚Äî');
}

/* ‚ïê‚ïê TAB 2: CUSTOMERS TABLE ‚ïê‚ïê */
function getCustFiltered(){
    const q=document.getElementById('custSearch').value.toLowerCase();
    const fS=document.getElementById('filtSalesman').value,fB=document.getElementById('filtBrand').value,fC=document.getElementById('filtCustomer').value,fP=document.getElementById('filtProduct').value,fD=document.getElementById('filtDate').value;
    let d=[...myMasterData];
    if(fS)d=d.filter(r=>String(r.salesmanCode)===fS);
    if(fB)d=d.filter(r=>r.brand===fB);if(fC)d=d.filter(r=>r.customer===fC);if(fP)d=d.filter(r=>r.product===fP);if(fD)d=d.filter(r=>r.dayDate===fD);
    if(q)d=d.filter(r=>[r.customerCode,r.customer,r.brand,r.product,r.dayDate,String(r.salesmanCode)].some(v=>String(v).toLowerCase().includes(q)));
    const sv=document.getElementById('custSortBy').value;
    if(sv){const[f,dir]=sv.split('-');const m=dir==='desc'?-1:1;
        const field=f==='customer'?'customer':f;
        d.sort((a,b)=>typeof a[field]==='number'?(a[field]-b[field])*m:String(a[field]).localeCompare(String(b[field]))*m);}
    return d;
}

function renderCustTable(){
    const data=getCustFiltered(),g=document.getElementById('custGroupBy').value,tbody=document.getElementById('custTableBody');
    if(!data.length){tbody.innerHTML='<tr><td colspan="9" class="no-data">No data found</td></tr>';document.getElementById('custTotalCY').textContent='0';document.getElementById('custTotalLY').textContent='0';return;}
    let html='',tCY=0,tLY=0;

    const getGroupVal=(r,field)=>{
        if(field==='salesman'){const sm=mySalesmen.find(s=>s.salesmanCode==r.salesmanCode);return sm?sm.salesman:String(r.salesmanCode);}
        return r[field];
    };

    if(g){
        const groups={};data.forEach(r=>{const k=getGroupVal(r,g);if(!groups[k])groups[k]=[];groups[k].push(r);});
        Object.keys(groups).sort().forEach(k=>{const rows=groups[k];let sCY=0,sLY=0;
            const label=g==='dayDate'?'Date':g==='salesman'?'Salesman':g.charAt(0).toUpperCase()+g.slice(1);
            html+=`<tr class="group-header-row"><td colspan="9">${sanitize(label)}: ${sanitize(k)} (${rows.length})</td></tr>`;
            rows.forEach(c=>{const cy=+c.actualCY||0,ly=+c.actualLY||0;sCY+=cy;sLY+=ly;html+=cRow(c,cy,ly);});
            html+=`<tr class="group-subtotal-row"><td colspan="7">Subtotal ‚Äî ${sanitize(k)}</td><td>${sCY.toLocaleString()}</td><td>${sLY.toLocaleString()}</td></tr>`;
            tCY+=sCY;tLY+=sLY;});
    }else{data.forEach(c=>{const cy=+c.actualCY||0,ly=+c.actualLY||0;tCY+=cy;tLY+=ly;html+=cRow(c,cy,ly);});}
    tbody.innerHTML=html;document.getElementById('custTotalCY').textContent=tCY.toLocaleString();document.getElementById('custTotalLY').textContent=tLY.toLocaleString();
}

function cRow(c,cy,ly){
    const sm=mySalesmen.find(s=>s.salesmanCode==c.salesmanCode);const smName=sm?sm.salesman:c.salesmanCode;
    return`<tr><td style="font-weight:500">${sanitize(smName)}</td><td>${sanitize(c.routeCode)}</td><td>${sanitize(c.customerCode)}</td><td style="font-weight:500;color:#333">${sanitize(c.customer)}</td><td>${sanitize(c.brand)}</td><td>${sanitize(c.product)}</td><td>${sanitize(c.dayDate)}</td><td class="sales-val">${cy.toLocaleString()}</td><td>${ly.toLocaleString()}</td></tr>`;
}

function populateCustFilters(){
    const fill=(id,vals,lbl)=>{const s=document.getElementById(id);s.innerHTML=`<option value="">All ${lbl}</option>`;vals.forEach(v=>{s.innerHTML+=`<option value="${sanitize(v[0])}">${sanitize(v[1])}</option>`;});};
    // Salesman filter shows name but filters by code
    const smOpts=mySalesmen.map(s=>[String(s.salesmanCode), `${s.salesman} (${s.salesmanCode})`]);
    fill('filtSalesman',smOpts,'Salesmen');
    fill('filtBrand',[...new Set(myMasterData.map(r=>r.brand))].sort().map(v=>[v,v]),'Brands');
    fill('filtCustomer',[...new Set(myMasterData.map(r=>r.customer))].sort().map(v=>[v,v]),'Customers');
    fill('filtProduct',[...new Set(myMasterData.map(r=>r.product))].sort().map(v=>[v,v]),'Products');
    fill('filtDate',[...new Set(myMasterData.map(r=>r.dayDate))].sort().map(v=>[v,v]),'Dates');
}

/* ‚ïê‚ïê TAB 3: SURVEYS ‚ïê‚ïê */
async function loadAllSurveys(){
    if(!POWER_AUTOMATE_GET_URL){document.getElementById('surveyTableContainer').innerHTML='<p class="no-data" style="padding:20px">Configure POWER_AUTOMATE_GET_URL to load surveys</p>';return;}
    try{
        document.getElementById('surveyTableContainer').innerHTML='<p class="survey-loading">Loading surveys...</p>';
        const smCodes=mySalesmen.map(s=>String(s.salesmanCode));
        console.log('Supervisor loading surveys for salesmen:',smCodes);
        const sep=POWER_AUTOMATE_GET_URL.includes('?')?'&':'?';
        const r=await fetch(POWER_AUTOMATE_GET_URL+sep+'t='+Date.now(),{mode:'cors'});
        if(r.ok){
            const data=await r.json();
            console.log('Survey GET response:',JSON.stringify(data).substring(0,500));
            const rows=Array.isArray(data)?data:(data.value||data.rows||[]);
            console.log('Total rows from Excel:',rows.length);
            if(rows.length>0)console.log('Row keys:',Object.keys(rows[0]));
            const g=(row,...keys)=>{for(const k of keys){if(row[k]!==undefined&&row[k]!==null&&String(row[k]).trim())return String(row[k]).trim();}return'';};
            const filtered=rows.filter(row=>{
                const code=g(row,'SalesmanCode','salesmanCode','Salesman Code','salesman_code','salesmancode');
                return smCodes.includes(code);
            });
            console.log('Filtered surveys:',filtered.length);
            allSurveys=filtered.map(row=>({
                customerName:g(row,'CustomerName','customerName','Customer Name'),
                customerCode:g(row,'CustomerCode','customerCode','Customer Code'),
                rating:parseInt(g(row,'Rating','rating'))||0,
                date:parseExcelDate(g(row,'Date','date')),
                time:parseExcelTime(g(row,'Time','time')),
                salesman:g(row,'Salesman','salesman'),
                salesmanCode:g(row,'SalesmanCode','salesmanCode','Salesman Code'),
                photoURLs:['Photo1URL','Photo2URL','Photo3URL','Photo4URL','Photo5URL'].map(k=>row[k]).filter(u=>u&&String(u).trim())
            }));
        }else{console.error('GET not OK:',r.status);}
    }catch(e){console.error('Load surveys error:',e);}
    document.getElementById('sumSurveys').textContent=allSurveys.length;
    populateSurveyFilters();
    renderSurveyTable();
}

function parseExcelDate(val){
    if(!val)return'';
    const n=Number(val);
    if(!isNaN(n)&&n>40000){
        const d=new Date((n-25569)*86400000);
        return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    }
    return String(val);
}

function parseExcelTime(val){
    if(!val)return'';
    const n=Number(val);
    if(!isNaN(n)&&n>=0&&n<1){
        const totalMins=Math.round(n*24*60);
        const h=Math.floor(totalMins/60);
        const m=totalMins%60;
        return(h<10?'0':'')+h+':'+(m<10?'0':'')+m;
    }
    if(!isNaN(n)&&n>40000){
        const frac=n-Math.floor(n);
        const totalMins=Math.round(frac*24*60);
        const h=Math.floor(totalMins/60);
        const m=totalMins%60;
        return(h<10?'0':'')+h+':'+(m<10?'0':'')+m;
    }
    return String(val);
}

function populateSurveyFilters(){
    const fill=(id,vals,lbl)=>{const s=document.getElementById(id);s.innerHTML=`<option value="">All ${lbl}</option>`;vals.forEach(v=>{s.innerHTML+=`<option value="${sanitize(v[0])}">${sanitize(v[1])}</option>`;});};
    const smOpts=[...new Set(allSurveys.map(s=>s.salesmanCode))].map(c=>{const sv=allSurveys.find(s=>s.salesmanCode==c);return[String(c),sv?sv.salesman+' ('+c+')':String(c)];});
    fill('survFiltSM',smOpts,'Salesmen');
    fill('survFiltCust',[...new Set(allSurveys.map(s=>s.customerName))].sort().map(v=>[v,v]),'Customers');
}

function getSurveyFiltered(){
    const q=document.getElementById('surveySearch').value.toLowerCase();
    const fSM=document.getElementById('survFiltSM').value,fC=document.getElementById('survFiltCust').value,fR=document.getElementById('survFiltRating').value;
    let d=[...allSurveys];
    if(fSM)d=d.filter(s=>String(s.salesmanCode)===fSM);
    if(fC)d=d.filter(s=>s.customerName===fC);
    if(fR==='low')d=d.filter(s=>s.rating>=1&&s.rating<=4);
    else if(fR==='mid')d=d.filter(s=>s.rating>=5&&s.rating<=7);
    else if(fR==='high')d=d.filter(s=>s.rating>=8&&s.rating<=10);
    if(q)d=d.filter(s=>[s.salesman,s.customerName,s.customerCode,s.date].some(v=>String(v).toLowerCase().includes(q)));
    const sv=document.getElementById('survSortBy').value;
    if(sv==='rating-desc')d.sort((a,b)=>b.rating-a.rating);
    else if(sv==='rating-asc')d.sort((a,b)=>a.rating-b.rating);
    else if(sv==='salesman-asc')d.sort((a,b)=>a.salesman.localeCompare(b.salesman));
    else if(sv==='customer-asc')d.sort((a,b)=>a.customerName.localeCompare(b.customerName));
    return d;
}

function renderSurveyTable(){
    const data=getSurveyFiltered();const container=document.getElementById('surveyTableContainer');
    if(!data.length){container.innerHTML='<p class="no-data" style="padding:20px">No surveys found</p>';return;}
    let html='<table class="data-table"><thead><tr><th>Date</th><th>Salesman</th><th>Customer</th><th>Code</th><th>Rating</th><th>Photos</th></tr></thead><tbody>';
    data.forEach(s=>{
        const rCls=s.rating>=8?'pct-high':s.rating>=5?'pct-mid':'pct-low';
        let photoCell=s.photoURLs.length?s.photoURLs.map((u,i)=>'<a href="'+sanitize(u)+'" target="_blank" class="photo-link">Photo '+(i+1)+'</a>').join(''):'<span class="photo-count-badge">0 photos</span>';
        html+=`<tr><td>${sanitize(s.date)}<br><span style="color:#999;font-size:.8em">${sanitize(s.time)}</span></td><td style="font-weight:500">${sanitize(s.salesman)}</td><td style="font-weight:500;color:#333">${sanitize(s.customerName)}</td><td>${sanitize(s.customerCode)}</td><td><span class="pct-badge ${rCls}">${s.rating}/10</span></td><td>${photoCell}</td></tr>`;
    });
    html+='</tbody></table>';
    container.innerHTML=html;
}

/* ‚ïê‚ïê DASHBOARD ‚ïê‚ïê */
function showDashboard(user){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('dashName').textContent=sanitize(user.userName);
    document.getElementById('dashCode').textContent=sanitize(user.userID);

    // Filter data for this supervisor
    mySalesmen=salesmanSalesData.filter(s=>s.assignedSPV==user.userID);
    myMasterData=masterData.filter(r=>r.assignedSPV==user.userID);

    // Summary
    const tTgt=mySalesmen.reduce((a,s)=>a+s.target,0);
    const tAct=mySalesmen.reduce((a,s)=>a+s.actualSales,0);
    const uniqueCustomers=[...new Set(myMasterData.map(r=>r.customerCode))];
    document.getElementById('sumSalesmen').textContent=mySalesmen.length;
    document.getElementById('sumTarget').textContent=tTgt.toLocaleString();
    document.getElementById('sumActual').textContent=tAct.toLocaleString();
    document.getElementById('sumPct').textContent=(tTgt?(tAct/tTgt*100):0).toFixed(1)+'%';
    document.getElementById('sumCustomers').textContent=uniqueCustomers.length;

    renderSalesmenTable();
    populateCustFilters();
    renderCustTable();
    loadAllSurveys();
}

/* ‚ïê‚ïê EVENTS ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded',()=>{
    ['custSearch','filtSalesman','filtBrand','filtCustomer','filtProduct','filtDate','custGroupBy','custSortBy'].forEach(id=>{
        const el=document.getElementById(id);el.addEventListener(el.tagName==='INPUT'?'input':'change',renderCustTable);
    });
    ['surveySearch','survFiltSM','survFiltCust','survFiltRating','survSortBy'].forEach(id=>{
        const el=document.getElementById(id);el.addEventListener(el.tagName==='INPUT'?'input':'change',renderSurveyTable);
    });
});

window.onload=async function(){
    await loadData();
    const s=sessionStorage.getItem('loggedInSupervisor');
    if(s){const u=JSON.parse(s);const user=usersData.find(x=>x.userID==u.userID&&x.role==='Supervisor');
    if(user){currentUser=user;showDashboard(user);}else sessionStorage.removeItem('loggedInSupervisor');}
};

document.getElementById('loginForm').addEventListener('submit',function(e){
    e.preventDefault();
    const name=document.getElementById('userName').value.trim(),code=document.getElementById('userCode').value.trim();
    const user=usersData.find(u=>u.userName.toLowerCase()===name.toLowerCase()&&String(u.userID)===code);
    if(!user){showError('Invalid credentials.');return;}
    if(user.role!=='Supervisor'){showError('Access Denied: This page is for Supervisor role only.');return;}
    sessionStorage.setItem('loggedInSupervisor',JSON.stringify(user));currentUser=user;showDashboard(user);
});

function showError(m){const e=document.getElementById('errorMessage');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',3000);}
function logout(){sessionStorage.removeItem('loggedInSupervisor');currentUser=null;document.getElementById('loginForm').reset();document.getElementById('dashboard').classList.remove('active');document.getElementById('loginScreen').style.display='flex';}
</script>
</body>
</html>
