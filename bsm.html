<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSM Portal</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);min-height:100vh}
        #loginScreen{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
        .login-container{background:#fff;border-radius:20px;padding:50px 40px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:450px;width:100%}
        .login-header{text-align:center;margin-bottom:40px}.login-icon{font-size:4em;margin-bottom:15px}
        .login-header h1{color:#333;margin-bottom:10px;font-size:2em}.login-header p{color:#666}
        .form-group{margin-bottom:25px}.form-group label{display:block;color:#333;font-weight:600;margin-bottom:8px}
        .form-group input{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:1em;transition:border-color .3s}
        .form-group input:focus{outline:none;border-color:#4facfe}
        .login-btn{width:100%;padding:15px;background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff;border:none;border-radius:10px;font-size:1.1em;font-weight:600;cursor:pointer;transition:transform .3s,box-shadow .3s;margin-top:10px}
        .login-btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(79,172,254,.4)}
        .error-message{background:#fee;color:#c33;padding:12px;border-radius:8px;margin-bottom:20px;text-align:center;display:none;border:1px solid #fcc}
        .back-link{text-align:center;margin-top:20px}.back-link a{color:#666;text-decoration:none}.back-link a:hover{color:#4facfe}

        #dashboard{display:none;background:#f5f7fa;min-height:100vh}#dashboard.active{display:block}
        .dashboard-container{max-width:1400px;margin:0 auto;padding:20px}
        .dashboard-header{background:#fff;border-radius:15px;padding:30px;margin-bottom:30px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center}
        .user-info h2{color:#333;margin-bottom:5px}.user-info p{color:#666}
        .logout-btn{background:rgba(79,172,254,.2);color:#2980b9;border:none;padding:12px 25px;border-radius:8px;cursor:pointer;font-size:1em;font-weight:600}
        .logout-btn:hover{background:rgba(79,172,254,.3)}

        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
        .summary-card{background:#fff;border-radius:15px;padding:25px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .summary-card .icon{font-size:2em;margin-bottom:10px}.summary-card .value{font-size:1.8em;font-weight:700;color:#333}.summary-card .label{color:#666;font-size:.85em;margin-top:5px}

        .tab-nav{display:flex;gap:0;margin-bottom:30px;background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .tab-btn{flex:1;padding:20px;text-align:center;cursor:pointer;font-size:1.05em;font-weight:600;color:#666;border:none;background:#fff;transition:all .3s;border-bottom:3px solid transparent}
        .tab-btn:hover{background:#f9f9f9;color:#333}
        .tab-btn.active{color:#2980b9;border-bottom-color:#4facfe;background:linear-gradient(180deg,#ebf5fb,#fff)}
        .tab-content{display:none}.tab-content.active{display:block}

        .section-card{background:#fff;border-radius:15px;padding:30px;margin-bottom:30px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .section-card h3{color:#333;margin-bottom:25px;font-size:1.4em;display:flex;align-items:center;gap:10px}

        .data-table{width:100%;border-collapse:collapse}
        .data-table thead{background:linear-gradient(135deg,#ebf5fb,#d6eaf8)}
        .data-table th{padding:14px 12px;text-align:left;color:#333;font-weight:600;font-size:.9em;white-space:nowrap}
        .data-table td{padding:14px 12px;border-bottom:1px solid #f0f0f0;color:#555;font-size:.9em}
        .data-table tbody tr:hover{background:#f9f9f9}
        .total-row{background:linear-gradient(135deg,#ebf5fb,#d6eaf8);font-weight:700}
        .total-row td{padding:18px 12px;border-bottom:none}
        .no-data{text-align:center;padding:40px;color:#999;font-style:italic}
        .sales-val{color:#2980b9;font-weight:600}
        .pct-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-weight:600;font-size:.85em}
        .pct-high{background:#d4edda;color:#155724}.pct-mid{background:#fff3cd;color:#856404}.pct-low{background:#f8d7da;color:#721c24}
        .mini-progress{width:80px;height:8px;background:#e0e0e0;border-radius:4px;display:inline-block;vertical-align:middle;margin-left:8px}
        .mini-progress-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#4facfe,#00f2fe)}

        .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:20px}
        .toolbar input[type="text"]{padding:10px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:.95em;min-width:200px}
        .toolbar input:focus,.toolbar select:focus{outline:none;border-color:#4facfe}
        .toolbar select{padding:10px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:.9em;background:#fff;cursor:pointer}
        .toolbar label{font-size:.85em;color:#666;font-weight:600}.toolbar-group{display:flex;align-items:center;gap:6px}
        .group-header-row td{background:linear-gradient(135deg,#d6eaf8,#ebf5fb);font-weight:700;color:#333;padding:12px;border-bottom:2px solid #4facfe}
        .group-subtotal-row td{background:#fafafa;font-weight:600;color:#555;font-style:italic;border-bottom:2px solid #e0e0e0}

        @media(max-width:768px){.dashboard-header{flex-direction:column;gap:20px;text-align:center}.summary-grid{grid-template-columns:1fr 1fr}.toolbar{flex-direction:column;align-items:stretch}.toolbar input[type="text"]{min-width:auto;width:100%}.tab-btn{font-size:.9em;padding:15px 10px}}
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-container">
        <div class="login-header"><div class="login-icon">üìä</div><h1>BSM Login</h1><p>Enter your credentials to continue</p></div>
        <div id="errorMessage" class="error-message"></div>
        <form id="loginForm">
            <div class="form-group"><label for="userName">User Name</label><input type="text" id="userName" placeholder="e.g. BSM" required></div>
            <div class="form-group"><label for="userCode">User ID</label><input type="text" id="userCode" placeholder="e.g. 3001" required></div>
            <button type="submit" class="login-btn">Log In</button>
        </form>
        <div class="back-link"><a href="index.html">‚Üê Back to Role Selection</a></div>
    </div>
</div>

<div id="dashboard">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="user-info"><h2>Welcome, <span id="dashName"></span>!</h2><p>BSM Code: <span id="dashCode"></span></p></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="summary-grid">
            <div class="summary-card"><div class="icon">üë®‚Äçüíº</div><div class="value" id="sumSPV">0</div><div class="label">Supervisors</div></div>
            <div class="summary-card"><div class="icon">üë•</div><div class="value" id="sumSM">0</div><div class="label">Salesmen</div></div>
            <div class="summary-card"><div class="icon">üéØ</div><div class="value" id="sumTgt">0</div><div class="label">Total Target</div></div>
            <div class="summary-card"><div class="icon">üí∞</div><div class="value" id="sumAct">0</div><div class="label">Total Actual</div></div>
            <div class="summary-card"><div class="icon">üìä</div><div class="value" id="sumPct">0%</div><div class="label">Achievement</div></div>
            <div class="summary-card"><div class="icon">üè™</div><div class="value" id="sumCust">0</div><div class="label">Customers</div></div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('supervisors')">üë®‚Äçüíº My Supervisors</button>
            <button class="tab-btn" onclick="switchTab('salesmen')">üë• All Salesmen</button>
            <button class="tab-btn" onclick="switchTab('customers')">üè™ All Sales Data</button>
        </div>

        <!-- TAB 1: Supervisors -->
        <div id="tab-supervisors" class="tab-content active">
            <div class="section-card">
                <h3>üë®‚Äçüíº Supervisors Performance</h3>
                <table class="data-table">
                    <thead><tr><th>Code</th><th>Supervisor</th><th>Routes</th><th>Target</th><th>Actual</th><th>%TGT</th><th>Remaining</th><th>Progress</th></tr></thead>
                    <tbody id="spvTableBody"><tr><td colspan="8" class="no-data">Loading‚Ä¶</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2: All Salesmen -->
        <div id="tab-salesmen" class="tab-content">
            <div class="section-card">
                <h3>üë• All Salesmen Performance</h3>
                <div class="toolbar">
                    <div class="toolbar-group"><label>Supervisor:</label><select id="smFiltSPV"><option value="">All</option></select></div>
                </div>
                <table class="data-table">
                    <thead><tr><th>Code</th><th>Salesman</th><th>Route</th><th>Supervisor</th><th>Target</th><th>Actual</th><th>%TGT</th><th>Remaining</th><th>Progress</th></tr></thead>
                    <tbody id="smTableBody"><tr><td colspan="9" class="no-data">Loading‚Ä¶</td></tr></tbody>
                    <tfoot><tr class="total-row"><td colspan="4">Total</td><td class="sales-val" id="smTotTgt">0</td><td class="sales-val" id="smTotAct">0</td><td class="sales-val" id="smTotPct">0%</td><td id="smTotRem">0</td><td></td></tr></tfoot>
                </table>
            </div>
        </div>

        <!-- TAB 3: All Customers -->
        <div id="tab-customers" class="tab-content">
            <div class="section-card">
                <h3>üè™ All Customer Sales Data</h3>
                <div class="toolbar">
                    <input type="text" id="custSearch" placeholder="üîç Search...">
                    <div class="toolbar-group"><label>Supervisor:</label><select id="filtSPV"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Salesman:</label><select id="filtSM"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Brand:</label><select id="filtBrand"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Customer:</label><select id="filtCust"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Date:</label><select id="filtDate"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Group By:</label><select id="custGroupBy"><option value="">None</option><option value="supervisor">Supervisor</option><option value="salesman">Salesman</option><option value="brand">Brand</option><option value="customer">Customer</option><option value="dayDate">Date</option></select></div>
                    <div class="toolbar-group"><label>Sort:</label><select id="custSortBy"><option value="">Default</option><option value="customer-asc">Customer ‚Üë</option><option value="customer-desc">Customer ‚Üì</option><option value="brand-asc">Brand ‚Üë</option><option value="brand-desc">Brand ‚Üì</option><option value="actualCY-asc">ACT-CY ‚Üë</option><option value="actualCY-desc">ACT-CY ‚Üì</option><option value="dayDate-asc">Date ‚Üë</option><option value="dayDate-desc">Date ‚Üì</option></select></div>
                </div>
                <table class="data-table">
                    <thead><tr><th>Supervisor</th><th>Salesman</th><th>Route</th><th>Code</th><th>Customer</th><th>Brand</th><th>Product</th><th>Date</th><th>ACT-CY</th><th>ACT-LY</th></tr></thead>
                    <tbody id="custTableBody"><tr><td colspan="10" class="no-data">Loading‚Ä¶</td></tr></tbody>
                    <tfoot><tr class="total-row"><td colspan="8">Total</td><td class="sales-val"><span id="custTotCY">0</span></td><td class="sales-val"><span id="custTotLY">0</span></td></tr></tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIrIwg_Lg7aaoaHzJZcA1VjagDF53RgZJt8Oe07NL7uwyiu7Z0p4C8Ycgu2ykhnmkW/exec';

let usersData=[],salesmanSalesData=[],supSalesData=[],bsmSalesData=[],masterData=[];
let currentUser=null,mySupervisors=[],mySalesmen=[],myMasterData=[];
function sanitize(s){const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}
function toNum(v){const n=Number(v);return isNaN(n)?0:n;}

async function loadFromAppsScript(userCode){
    if(!APPS_SCRIPT_URL)return false;
    try{
        const url=APPS_SCRIPT_URL+'?action=login&code='+encodeURIComponent(userCode);
        const r=await fetch(url);if(!r.ok)return false;
        const data=await r.json();if(data.error)return false;
        if(data.user)usersData=[{userID:toNum(data.user.UserID),userName:data.user.UserName||'',role:data.user.Role||''}];
        if(data.salesmanSales)salesmanSalesData=data.salesmanSales.map(r=>({salesmanCode:toNum(r.SalesmanCode),salesman:r.Salesman||'',routeCode:toNum(r.RouteCode),assignedSPV:toNum(r.AssignedSPV),target:toNum(r.Target),actualSales:toNum(r.ActualSales),targetPercent:toNum(r.TargetPercent)}));
        if(data.supSales)supSalesData=data.supSales.map(r=>({supervisorCode:toNum(r.SupervisorCode),supervisor:r.Supervisor||'',routeCode:toNum(r.RouteCode),assignedBSM:toNum(r.AssignedBSM),target:toNum(r.Target),actualSales:toNum(r.ActualSales),targetPercent:toNum(r.TargetPercent)}));
        if(data.bsmSales)bsmSalesData=data.bsmSales.map(r=>({bsmCode:toNum(r.BSMCode),bsm:r.BSM||'',routeCode:toNum(r.RouteCode),target:toNum(r.Target),actualSales:toNum(r.ActualSales),targetPercent:toNum(r.TargetPercent)}));
        if(data.masterData)masterData=data.masterData.map(r=>({salesmanCode:toNum(r.SalesmanCode),routeCode:toNum(r.RouteCode),assignedSPV:toNum(r.AssignedSPV),customerCode:String(r.CustomerCode||''),customer:r.Customer||'',brand:r.Brand||'',productGroup:r.ProductGroup||'',subBrand:r.SubBrand||'',product:r.Product||'',dayDate:String(r.DayDate||''),actualCY:toNum(r.ActualCY),actualLY:toNum(r.ActualLY)}));
        console.log('Apps Script: loaded',supSalesData.length,'SUP,',salesmanSalesData.length,'SM,',masterData.length,'master');
        return true;
    }catch(e){console.error('Apps Script error:',e);return false;}
}

async function loadData(){
    try{
        const[u,sm,sp,bs,md]=await Promise.all([fetch('users_data.json'),fetch('salesman_sales.json'),fetch('sup_sales.json'),fetch('bsm_sales.json'),fetch('master_data.json')]);
        usersData=await u.json();salesmanSalesData=await sm.json();supSalesData=await sp.json();bsmSalesData=await bs.json();masterData=await md.json();
    }catch(e){console.error(e);
        usersData=[{"userID":75241,"userName":"Aseel","role":"Salesman"},{"userID":75242,"userName":"Ali","role":"Salesman"},{"userID":75243,"userName":"Ahmed","role":"Salesman"},{"userID":75244,"userName":"Amer","role":"Salesman"},{"userID":75245,"userName":"Amjad","role":"Salesman"},{"userID":12345,"userName":"Admin","role":"Management"},{"userID":123456,"userName":"SUP","role":"Supervisor"},{"userID":3001,"userName":"BSM","role":"BSM"}];
        salesmanSalesData=[{"salesmanCode":75241,"salesman":"Aseel","routeCode":1,"assignedSPV":123456,"target":3000,"actualSales":2700,"targetPercent":90},{"salesmanCode":75242,"salesman":"Ali","routeCode":2,"assignedSPV":123456,"target":3200,"actualSales":3000,"targetPercent":93.75},{"salesmanCode":75243,"salesman":"Ahmed","routeCode":3,"assignedSPV":123456,"target":3100,"actualSales":2800,"targetPercent":90.32},{"salesmanCode":75244,"salesman":"Amer","routeCode":4,"assignedSPV":123456,"target":3500,"actualSales":2700,"targetPercent":77.14},{"salesmanCode":75245,"salesman":"Amjad","routeCode":5,"assignedSPV":123456,"target":3300,"actualSales":2900,"targetPercent":87.88}];
        supSalesData=[{"supervisorCode":123456,"supervisor":"SUP","routeCode":1,"assignedBSM":3001,"target":3000,"actualSales":2700,"targetPercent":90},{"supervisorCode":123456,"supervisor":"SUP","routeCode":2,"assignedBSM":3001,"target":3200,"actualSales":3000,"targetPercent":94},{"supervisorCode":123456,"supervisor":"SUP","routeCode":3,"assignedBSM":3001,"target":3100,"actualSales":2800,"targetPercent":90},{"supervisorCode":123456,"supervisor":"SUP","routeCode":4,"assignedBSM":3001,"target":3500,"actualSales":2700,"targetPercent":77},{"supervisorCode":123456,"supervisor":"SUP","routeCode":5,"assignedBSM":3001,"target":3300,"actualSales":2900,"targetPercent":88}];
        bsmSalesData=[{"bsmCode":3001,"bsm":"BSM","routeCode":1,"target":3000,"actualSales":2700,"targetPercent":90},{"bsmCode":3001,"bsm":"BSM","routeCode":2,"target":3200,"actualSales":3000,"targetPercent":94},{"bsmCode":3001,"bsm":"BSM","routeCode":3,"target":3100,"actualSales":2800,"targetPercent":90},{"bsmCode":3001,"bsm":"BSM","routeCode":4,"target":3500,"actualSales":2700,"targetPercent":77},{"bsmCode":3001,"bsm":"BSM","routeCode":5,"target":3300,"actualSales":2900,"targetPercent":88}];
        masterData=[{"salesmanCode":75241,"routeCode":1,"assignedSPV":123456,"customerCode":"C01","customer":"Aswaq 1","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","dayDate":"2026-02-07","actualCY":2000,"actualLY":6000},{"salesmanCode":75241,"routeCode":1,"assignedSPV":123456,"customerCode":"C01","customer":"Aswaq 1","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","dayDate":"2026-02-07","actualCY":700,"actualLY":3000},{"salesmanCode":75242,"routeCode":2,"assignedSPV":123456,"customerCode":"C03","customer":"Aswaq 3","brand":"BARBICAN","productGroup":"BBN CAN","subBrand":"BBN CAN APPLE","product":"BARBICAN CAN APPLE 330x6","dayDate":"2026-02-08","actualCY":1500,"actualLY":2000},{"salesmanCode":75242,"routeCode":2,"assignedSPV":123456,"customerCode":"C03","customer":"Aswaq 3","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","dayDate":"2026-02-08","actualCY":1500,"actualLY":1000},{"salesmanCode":75243,"routeCode":3,"assignedSPV":123456,"customerCode":"C04","customer":"Aswaq 4","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","dayDate":"2026-02-08","actualCY":2000,"actualLY":1000},{"salesmanCode":75243,"routeCode":3,"assignedSPV":123456,"customerCode":"C04","customer":"Aswaq 4","brand":"BARBICAN","productGroup":"BBN CAN","subBrand":"BBN CAN APPLE","product":"BARBICAN CAN APPLE 330x6","dayDate":"2026-02-09","actualCY":800,"actualLY":1000},{"salesmanCode":75244,"routeCode":4,"assignedSPV":123456,"customerCode":"C05","customer":"Aswaq 5","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","dayDate":"2026-02-09","actualCY":2700,"actualLY":2200},{"salesmanCode":75245,"routeCode":5,"assignedSPV":123456,"customerCode":"C06","customer":"Aswaq 6","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","dayDate":"2026-02-10","actualCY":2900,"actualLY":2500}];
    }
}

function switchTab(t){
    ['supervisors','salesmen','customers'].forEach(n=>{
        document.getElementById('tab-'+n).classList.toggle('active',n===t);
    });
    document.querySelectorAll('.tab-btn').forEach((b,i)=>{b.classList.toggle('active',i===['supervisors','salesmen','customers'].indexOf(t));});
}

/* ‚ïê‚ïê TAB 1: Supervisors ‚ïê‚ïê */
function renderSPVTable(){
    const tbody=document.getElementById('spvTableBody');
    // Group sup_sales by supervisor code
    const spvMap={};
    mySupervisors.forEach(s=>{
        if(!spvMap[s.supervisorCode]) spvMap[s.supervisorCode]={code:s.supervisorCode,name:s.supervisor,routes:[],tgt:0,act:0};
        spvMap[s.supervisorCode].routes.push(s.routeCode);
        spvMap[s.supervisorCode].tgt+=s.target;
        spvMap[s.supervisorCode].act+=s.actualSales;
    });
    const spvList=Object.values(spvMap);
    if(!spvList.length){tbody.innerHTML='<tr><td colspan="8" class="no-data">No supervisors assigned</td></tr>';return;}
    let html='';
    spvList.forEach(s=>{
        const pct=s.tgt?(s.act/s.tgt*100):0;const rem=s.tgt-s.act;
        const cls=pct>=95?'pct-high':pct>=85?'pct-mid':'pct-low';
        html+=`<tr><td>${sanitize(s.code)}</td><td style="font-weight:600;color:#333">${sanitize(s.name)}</td><td>${s.routes.join(', ')}</td><td>${s.tgt.toLocaleString()}</td><td class="sales-val">${s.act.toLocaleString()}</td><td><span class="pct-badge ${cls}">${pct.toFixed(1)}%</span></td><td>${rem>0?rem.toLocaleString():'‚Äî'}</td><td><div class="mini-progress"><div class="mini-progress-fill" style="width:${Math.min(pct,100)}%"></div></div></td></tr>`;
    });
    tbody.innerHTML=html;
}

/* ‚ïê‚ïê TAB 2: All Salesmen ‚ïê‚ïê */
function renderSMTable(){
    const fSPV=document.getElementById('smFiltSPV').value;
    let data=[...mySalesmen];
    if(fSPV) data=data.filter(s=>String(s.assignedSPV)===fSPV);
    const tbody=document.getElementById('smTableBody');
    if(!data.length){tbody.innerHTML='<tr><td colspan="9" class="no-data">No salesmen found</td></tr>';return;}
    let html='',tT=0,tA=0;
    data.forEach(s=>{
        const spv=mySupervisors.find(x=>x.supervisorCode==s.assignedSPV);const spvName=spv?spv.supervisor:s.assignedSPV;
        const rem=s.target-s.actualSales;const pct=s.targetPercent;
        const cls=pct>=95?'pct-high':pct>=85?'pct-mid':'pct-low';
        tT+=s.target;tA+=s.actualSales;
        html+=`<tr><td>${sanitize(s.salesmanCode)}</td><td style="font-weight:600;color:#333">${sanitize(s.salesman)}</td><td>${sanitize(s.routeCode)}</td><td>${sanitize(spvName)}</td><td>${s.target.toLocaleString()}</td><td class="sales-val">${s.actualSales.toLocaleString()}</td><td><span class="pct-badge ${cls}">${pct.toFixed(1)}%</span></td><td>${rem>0?rem.toLocaleString():'‚Äî'}</td><td><div class="mini-progress"><div class="mini-progress-fill" style="width:${Math.min(pct,100)}%"></div></div></td></tr>`;
    });
    tbody.innerHTML=html;
    const oP=tT?(tA/tT*100):0;
    document.getElementById('smTotTgt').textContent=tT.toLocaleString();document.getElementById('smTotAct').textContent=tA.toLocaleString();
    document.getElementById('smTotPct').textContent=oP.toFixed(1)+'%';document.getElementById('smTotRem').textContent=(tT-tA>0?(tT-tA).toLocaleString():'‚Äî');
}

/* ‚ïê‚ïê TAB 3: All Customers ‚ïê‚ïê */
function getCustFiltered(){
    const q=document.getElementById('custSearch').value.toLowerCase();
    const fSPV=document.getElementById('filtSPV').value,fSM=document.getElementById('filtSM').value,fB=document.getElementById('filtBrand').value,fC=document.getElementById('filtCust').value,fD=document.getElementById('filtDate').value;
    let d=[...myMasterData];
    if(fSPV)d=d.filter(r=>String(r.assignedSPV)===fSPV);
    if(fSM)d=d.filter(r=>String(r.salesmanCode)===fSM);
    if(fB)d=d.filter(r=>r.brand===fB);if(fC)d=d.filter(r=>r.customer===fC);if(fD)d=d.filter(r=>r.dayDate===fD);
    if(q)d=d.filter(r=>[r.customerCode,r.customer,r.brand,r.product,r.dayDate,String(r.salesmanCode)].some(v=>String(v).toLowerCase().includes(q)));
    const sv=document.getElementById('custSortBy').value;
    if(sv){const[f,dir]=sv.split('-');const m=dir==='desc'?-1:1;d.sort((a,b)=>typeof a[f]==='number'?(a[f]-b[f])*m:String(a[f]).localeCompare(String(b[f]))*m);}
    return d;
}

function renderCustTable(){
    const data=getCustFiltered(),g=document.getElementById('custGroupBy').value,tbody=document.getElementById('custTableBody');
    if(!data.length){tbody.innerHTML='<tr><td colspan="10" class="no-data">No data found</td></tr>';document.getElementById('custTotCY').textContent='0';document.getElementById('custTotLY').textContent='0';return;}
    let html='',tCY=0,tLY=0;
    const getName=(r,field)=>{
        if(field==='supervisor'){const sp=mySupervisors.find(x=>x.supervisorCode==r.assignedSPV);return sp?sp.supervisor:String(r.assignedSPV);}
        if(field==='salesman'){const sm=mySalesmen.find(x=>x.salesmanCode==r.salesmanCode);return sm?sm.salesman:String(r.salesmanCode);}
        return r[field];
    };
    if(g){
        const groups={};data.forEach(r=>{const k=getName(r,g);if(!groups[k])groups[k]=[];groups[k].push(r);});
        Object.keys(groups).sort().forEach(k=>{const rows=groups[k];let sCY=0,sLY=0;
            const label=g==='dayDate'?'Date':g.charAt(0).toUpperCase()+g.slice(1);
            html+=`<tr class="group-header-row"><td colspan="10">${sanitize(label)}: ${sanitize(k)} (${rows.length})</td></tr>`;
            rows.forEach(c=>{const cy=+c.actualCY||0,ly=+c.actualLY||0;sCY+=cy;sLY+=ly;html+=cRow(c,cy,ly);});
            html+=`<tr class="group-subtotal-row"><td colspan="8">Subtotal ‚Äî ${sanitize(k)}</td><td>${sCY.toLocaleString()}</td><td>${sLY.toLocaleString()}</td></tr>`;tCY+=sCY;tLY+=sLY;});
    }else{data.forEach(c=>{const cy=+c.actualCY||0,ly=+c.actualLY||0;tCY+=cy;tLY+=ly;html+=cRow(c,cy,ly);});}
    tbody.innerHTML=html;document.getElementById('custTotCY').textContent=tCY.toLocaleString();document.getElementById('custTotLY').textContent=tLY.toLocaleString();
}

function cRow(c,cy,ly){
    const spv=mySupervisors.find(x=>x.supervisorCode==c.assignedSPV);const spvN=spv?spv.supervisor:c.assignedSPV;
    const sm=mySalesmen.find(x=>x.salesmanCode==c.salesmanCode);const smN=sm?sm.salesman:c.salesmanCode;
    return`<tr><td>${sanitize(spvN)}</td><td style="font-weight:500">${sanitize(smN)}</td><td>${sanitize(c.routeCode)}</td><td>${sanitize(c.customerCode)}</td><td style="font-weight:500;color:#333">${sanitize(c.customer)}</td><td>${sanitize(c.brand)}</td><td>${sanitize(c.product)}</td><td>${sanitize(c.dayDate)}</td><td class="sales-val">${cy.toLocaleString()}</td><td>${ly.toLocaleString()}</td></tr>`;
}

function populateFilters(){
    const fill=(id,vals,lbl)=>{const s=document.getElementById(id);s.innerHTML=`<option value="">All ${lbl}</option>`;vals.forEach(v=>{s.innerHTML+=`<option value="${sanitize(v[0])}">${sanitize(v[1])}</option>`;});};
    const spvUniq=[...new Map(mySupervisors.map(s=>[s.supervisorCode,s])).values()];
    const spvOpts=spvUniq.map(s=>[String(s.supervisorCode),`${s.supervisor} (${s.supervisorCode})`]);
    fill('filtSPV',spvOpts,'Supervisors');fill('smFiltSPV',spvOpts,'Supervisors');
    fill('filtSM',mySalesmen.map(s=>[String(s.salesmanCode),`${s.salesman} (${s.salesmanCode})`]),'Salesmen');
    fill('filtBrand',[...new Set(myMasterData.map(r=>r.brand))].sort().map(v=>[v,v]),'Brands');
    fill('filtCust',[...new Set(myMasterData.map(r=>r.customer))].sort().map(v=>[v,v]),'Customers');
    fill('filtDate',[...new Set(myMasterData.map(r=>r.dayDate))].sort().map(v=>[v,v]),'Dates');
}

function showDashboard(user){
    document.getElementById('loginScreen').style.display='none';document.getElementById('dashboard').classList.add('active');
    document.getElementById('dashName').textContent=sanitize(user.userName);document.getElementById('dashCode').textContent=sanitize(user.userID);

    // Get supervisors assigned to this BSM
    mySupervisors=supSalesData.filter(s=>s.assignedBSM==user.userID);
    // Get all supervisor codes under this BSM
    const spvCodes=[...new Set(mySupervisors.map(s=>s.supervisorCode))];
    // Get all salesmen under those supervisors
    mySalesmen=salesmanSalesData.filter(s=>spvCodes.includes(s.assignedSPV));
    // Get all master data under those supervisors
    myMasterData=masterData.filter(r=>spvCodes.includes(r.assignedSPV));

    // Summary
    const tT=mySalesmen.reduce((a,s)=>a+s.target,0),tA=mySalesmen.reduce((a,s)=>a+s.actualSales,0);
    document.getElementById('sumSPV').textContent=spvCodes.length;
    document.getElementById('sumSM').textContent=mySalesmen.length;
    document.getElementById('sumTgt').textContent=tT.toLocaleString();
    document.getElementById('sumAct').textContent=tA.toLocaleString();
    document.getElementById('sumPct').textContent=(tT?(tA/tT*100):0).toFixed(1)+'%';
    document.getElementById('sumCust').textContent=[...new Set(myMasterData.map(r=>r.customerCode))].length;

    populateFilters();renderSPVTable();renderSMTable();renderCustTable();
}

document.addEventListener('DOMContentLoaded',()=>{
    ['custSearch','filtSPV','filtSM','filtBrand','filtCust','filtDate','custGroupBy','custSortBy'].forEach(id=>{
        const el=document.getElementById(id);el.addEventListener(el.tagName==='INPUT'?'input':'change',renderCustTable);
    });
    document.getElementById('smFiltSPV').addEventListener('change',renderSMTable);
});

window.onload=async function(){await loadData();const s=sessionStorage.getItem('loggedInBSM');if(s){const u=JSON.parse(s);if(APPS_SCRIPT_URL){await loadFromAppsScript(u.userID);}const user=usersData.find(x=>x.userID==u.userID&&x.role==='BSM');if(user){currentUser=user;showDashboard(user);}else sessionStorage.removeItem('loggedInBSM');}};

document.getElementById('loginForm').addEventListener('submit',async function(e){e.preventDefault();
    const name=document.getElementById('userName').value.trim(),code=document.getElementById('userCode').value.trim();
    const btn=this.querySelector('button[type="submit"]');btn.disabled=true;btn.textContent='Loading...';
    if(APPS_SCRIPT_URL){await loadFromAppsScript(code);}
    const user=usersData.find(u=>u.userName.toLowerCase()===name.toLowerCase()&&String(u.userID)===code);
    btn.disabled=false;btn.textContent='Log In';
    if(!user){showError('Invalid credentials.');return;}if(user.role!=='BSM'){showError('Access Denied: This page is for BSM role only.');return;}
    sessionStorage.setItem('loggedInBSM',JSON.stringify(user));currentUser=user;showDashboard(user);});

function showError(m){const e=document.getElementById('errorMessage');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',3000);}
function logout(){sessionStorage.removeItem('loggedInBSM');currentUser=null;document.getElementById('loginForm').reset();document.getElementById('dashboard').classList.remove('active');document.getElementById('loginScreen').style.display='flex';}
</script>
</body>
</html>
